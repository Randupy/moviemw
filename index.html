<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultimate Player</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
    <style>
        body { background: #000; color: #fff; margin: 0; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; }
        #status-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .loader { width: 40px; height: 40px; border: 4px solid #333; border-top-color: #248bf2; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #player-container { width: 100%; display: none; background: #000; position: relative; }
        video { width: 100%; max-height: 80vh; }
        #stats { margin-top: 15px; font-size: 13px; color: #aaa; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; min-width: 200px; }
        .controls { display: flex; justify-content: center; gap: 20px; padding: 20px; background: #111; }
        button { background: #248bf2; border: none; color: #fff; padding: 10px 20px; border-radius: 8px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="status-container">
        <div class="loader"></div>
        <h3 id="movie-name">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ—Ä—Ä–µ–Ω—Ç–∞...</h3>
        <div id="status-text">–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ø–∏—Ä–∞–º–∏...</div>
        <div id="stats">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ç—Ä–µ–∫–µ—Ä–∞–º...</div>
    </div>

    <div id="player-container">
        <div id="video-target"></div>
        <div class="controls">
            <button onclick="skip(-10)">-10—Å</button>
            <button id="playBtn" onclick="togglePlay()">–ü–∞—É–∑–∞</button>
            <button onclick="skip(10)">+10—Å</button>
        </div>
    </div>

    <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const urlParams = new URLSearchParams(window.location.search);
    const magnet = urlParams.get('magnet');
    const statsEl = document.getElementById('stats');
    const statusText = document.getElementById('status-text');

    const client = new WebTorrent();

    // –°–ø–∏—Å–æ–∫ "–º–æ—Å—Ç–æ–≤" –º–µ–∂–¥—É –æ–±—ã—á–Ω—ã–º–∏ —Ç–æ—Ä—Ä–µ–Ω—Ç–∞–º–∏ –∏ –±—Ä–∞—É–∑–µ—Ä–æ–º (WebRTC —Ç—Ä–µ–∫–µ—Ä—ã)
    const announceList = [
        'wss://tracker.btorrent.xyz',
        'wss://tracker.openwebtorrent.com',
        'wss://tracker.fastcast.nz',
        'wss://tracker.webtorrent.dev',
        'wss://tracker.files.fm:7073/announce'
    ];

    if (magnet) {
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–∫–µ—Ä—ã –∫ –º–∞–≥–Ω–∏—Ç—É –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –±—Ä–∞—É–∑–µ—Ä–Ω–æ–≥–æ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞
        const trackerParams = announceList.map(t => `&tr=${encodeURIComponent(t)}`).join('');
        const fullMagnet = magnet + trackerParams;

        statusText.innerText = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ø–∏—Ä–∞–º...";

        client.add(fullMagnet, function (torrent) {
            console.log('Info hash:', torrent.infoHash);

            // –ò—â–µ–º –≤–∏–¥–µ–æ—Ñ–∞–π–ª (mp4, mkv, webm, avi)
            const file = torrent.files.find(f =>
                f.name.endsWith('.mp4') ||
                f.name.endsWith('.mkv') ||
                f.name.endsWith('.webm') ||
                f.name.endsWith('.avi')
            );

            if (file) {
                // –°—Ç—Ä–∏–º–∏–º —Ñ–∞–π–ª –≤ —ç–ª–µ–º–µ–Ω—Ç —Å id "video-target"
                file.appendTo('#video-target', {
                    autoplay: true,
                    controls: true,
                    muted: false
                });

                // –¢–∞–π–º–µ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è –ø–∏—Ä–æ–≤
                setTimeout(() => {
                    if (torrent.numPeers === 0) {
                        statusText.innerHTML = "‚ö†Ô∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö Web-–ø–∏—Ä–æ–≤.<br><small>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ç–æ—Ä—Ä–µ–Ω—Ç –∏–ª–∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ</small>";
                    }
                }, 10000);

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
                setInterval(() => {
                    const speed = (torrent.downloadSpeed / (1024 * 1024)).toFixed(2);
                    const progress = (torrent.progress * 100).toFixed(1);

                    statsEl.innerHTML = `
                        üë• –ü–∏—Ä—ã (Web): ${torrent.numPeers}<br>
                        üöÄ –°–∫–æ—Ä–æ—Å—Ç—å: ${speed} –ú–ë/—Å<br>
                        üìä –ü—Ä–æ–≥—Ä–µ—Å—Å: ${progress}%
                    `;

                    if (torrent.numPeers > 0) {
                        if (torrent.downloadSpeed > 0) {
                            statusText.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...";
                        } else {
                            statusText.innerText = "–ü–æ–∏—Å–∫ –≤–∏–¥–µ–æ-–±–ª–æ–∫–æ–≤...";
                        }
                    }
                }, 1000);

                // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞, –∫–æ–≥–¥–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞
                torrent.on('download', () => {
                    if (torrent.progress > 0.0001) {
                        document.getElementById('status-container').style.display = 'none';
                        document.getElementById('player-container').style.display = 'block';
                    }
                });
            } else {
                statusText.innerText = "‚ùå –í–∏–¥–µ–æ—Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤–Ω—É—Ç—Ä–∏ —Ç–æ—Ä—Ä–µ–Ω—Ç–∞";
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –∫–ª–∏–µ–Ω—Ç–∞
        client.on('error', function (err) {
            console.error('WebTorrent Error:', err.message);
            statusText.innerText = "–û—à–∏–±–∫–∞: " + err.message;
        });
    } else {
        statusText.innerText = "‚ùå –ú–∞–≥–Ω–∏—Ç-—Å—Å—ã–ª–∫–∞ –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞";
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–µ–æ
    function togglePlay() {
        const v = document.querySelector('video');
        if (!v) return;
        if (v.paused) {
            v.play();
            document.getElementById('playBtn').innerText = "–ü–∞—É–∑–∞";
        } else {
            v.pause();
            document.getElementById('playBtn').innerText = "–ü—É—Å–∫";
        }
    }

    function skip(time) {
        const v = document.querySelector('video');
        if (v) v.currentTime += time;
    }
</script>
</body>
</html>
