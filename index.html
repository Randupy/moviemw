<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Movie App Player</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
    <style>
        body { background: #0e0e0e; color: #fff; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #status-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .loader { width: 50px; height: 50px; border: 5px solid #333; border-top-color: #0088cc; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #stats { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-top: 20px; font-size: 14px; line-height: 1.6; min-width: 200px; }
        #player-container { width: 100%; display: none; background: #000; }
        video { width: 100%; height: 100vh; background: #000; }
        .error-text { color: #ff4d4d; font-size: 14px; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="status-container">
        <div class="loader"></div>
        <div id="status-text" style="font-weight: bold; font-size: 18px;">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
        <div id="stats">
            üë• –ü–∏—Ä—ã: <span id="peers-count">0</span><br>
            üöÄ –°–∫–æ—Ä–æ—Å—Ç—å: <span id="download-speed">0</span> –ú–ë/—Å<br>
            üìä –ü—Ä–æ–≥—Ä–µ—Å—Å: <span id="progress-percent">0</span>%
        </div>
        <div id="error-log" class="error-text"></div>
    </div>

    <div id="player-container">
        <video id="video-player" controls playsinline autoplay></video>
    </div>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Movie App Player</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
    <style>
        body { background: #0e0e0e; color: #fff; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #status-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .loader { width: 50px; height: 50px; border: 5px solid #333; border-top-color: #0088cc; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #stats { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-top: 20px; font-size: 14px; line-height: 1.6; min-width: 200px; }
        #player-container { width: 100%; display: none; background: #000; }
        video { width: 100%; height: 100vh; background: #000; }
        .error-text { color: #ff4d4d; font-size: 14px; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="status-container">
        <div class="loader"></div>
        <div id="status-text" style="font-weight: bold; font-size: 18px;">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
        <div id="stats">
            üë• –ü–∏—Ä—ã: <span id="peers-count">0</span><br>
            üöÄ –°–∫–æ—Ä–æ—Å—Ç—å: <span id="download-speed">0</span> –ú–ë/—Å<br>
            üìä –ü—Ä–æ–≥—Ä–µ—Å—Å: <span id="progress-percent">0</span>%
        </div>
        <div id="error-log" class="error-text"></div>
    </div>

    <div id="player-container">
        <video id="video-player" controls playsinline autoplay></video>
    </div>

    <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const statsEl = document.getElementById('stats');
    const statusText = document.getElementById('status-text');
    const client = new WebTorrent();

    // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—å–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤
    const announceList = [
        'wss://tracker.btorrent.xyz',
        'wss://tracker.openwebtorrent.com'
    ];

    const urlParams = new URLSearchParams(window.location.search);
    const magnet = urlParams.get('magnet');

    if (magnet) {
        statusText.innerText = "–ü–æ–∏—Å–∫ —Ç—Ä–µ–∫–µ—Ä–æ–≤...";
        
        // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Ç—Ä–µ–∫–µ—Ä–∞–º
        announceList.forEach(url => {
            const ws = new WebSocket(url);
            ws.onopen = () => console.log("‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Ç—Ä–µ–∫–µ—Ä–æ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: " + url);
            ws.onerror = () => {
                console.error("‚ùå –¢—Ä–µ–∫–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: " + url);
                statusText.innerHTML += `<br><small style="color:red">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${url.split('//')[1]}</small>`;
            };
        });

        client.add(magnet, { announce: announceList }, function (torrent) {
            console.log('–•—ç—à:', torrent.infoHash);

            setInterval(() => {
                // –ï—Å–ª–∏ –ø–∏—Ä–æ–≤ 0, –ø—Ä–æ–≤–µ—Ä–∏–º —Å—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞
                if (torrent.numPeers === 0) {
                    statusText.innerText = "–ü–∏—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ VPN/UDP.";
                }
                
                statsEl.innerHTML = `
                    üåê –°–æ–µ–¥–∏–Ω–µ–Ω–∏–π: ${torrent.numPeers}<br>
                    ‚¨áÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞: ${(torrent.downloadSpeed / 1024).toFixed(1)} KB/s<br>
                    üì° –¢—Ä–µ–∫–µ—Ä–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ: ${torrent.discovery.tracker ? '–î–∞' : '–ù–µ—Ç'}
                `;
            }, 1000);

            const file = torrent.files.find(f => f.name.match(/\.(mp4|mkv|webm)$/i));
            if (file) {
                file.appendTo('#video-target', { autoplay: true, controls: true });
            }
        });
    }
</script>
</body>
</html>

